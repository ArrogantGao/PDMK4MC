#include <gtest/gtest.h>
#include <hpdmk.h>
#include <ewald.hpp>

#include <cmath>
#include <iostream>
#include <vector>
#include <omp.h>

TEST(EwaldTest, BasicAssertions) {
    double q_array[] = {1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, 1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0, -1.0};

    double r_array[][3] = {
        {90.08289010963986, 16.346277804181597, 40.00957928829207}, 
        {52.785218139457676, 92.55272318903631, 65.19165489008921}, 
        {86.30208245477442, 71.67484176910226, 32.119705346350024}, 
        {49.6847936445754, 95.73893335557422, 79.41499457519606}, 
        {96.64750655178618, 42.480925208911394, 50.8055191437669}, 
        {98.47236356797289, 96.03469209682225, 5.819968075676973}, 
        {94.3959863862568, 26.85423760786898, 69.4652218872447}, 
        {86.65490897150289, 35.08208621470783, 59.58152237752362}, 
        {45.38153746402202, 4.48715826180448, 54.77351595306443}, 
        {6.290346876051056, 57.94341403683817, 44.62494540314344}, 
        {35.5121497523154, 31.896444717946526, 75.74056664577729}, 
        {97.31190906408655, 81.28770829132382, 99.36783704441513}, 
        {11.447564710953062, 58.71432628891993, 73.30262168688463}, 
        {64.77937785610389, 99.12270001069028, 62.17591022361491}, 
        {24.389246026183777, 66.93500967189155, 31.548055545068166}, 
        {66.56087462176767, 7.337173162214283, 87.67350357250913}, 
        {76.67008065694294, 22.346354190028705, 25.44591219105361}, 
        {90.20643902455812, 0.3895823060108716, 61.75402479041787}, 
        {74.14336401507374, 35.89736470581869, 46.88200144577633}, 
        {34.89059657985164, 43.53430829363791, 17.359185395218045}, 
        {24.462399122457867, 4.632788423916501, 89.02285845498076}, 
        {74.45349294775066, 18.23050007708694, 99.44378942317131}, 
        {92.07362763554335, 35.21254256443217, 54.02640862442269}, 
        {81.71950374538605, 3.868993450270508, 82.79949344242007}, 
        {86.61720301953763, 35.98654693068718, 1.4682172953524808}, 
        {86.22190737400794, 97.60025967992024, 98.63350837650877}, 
        {62.834812112322425, 69.95707823512177, 64.17110739025283}, 
        {86.44310101774259, 42.33474942585273, 16.07826126039098}, 
        {47.90628602386802, 73.6500395478075, 51.218493079588065}, 
        {77.38611958066215, 66.18918048395322, 97.06757425589831}, 
        {60.56927679490055, 25.03463972214063, 55.8764476416411}, 
        {51.9420749040075, 78.47668930138873, 84.09653135641474}, 
        {87.14390472312198, 72.52581096259276, 75.433862113863}, 
        {12.190539863750116, 54.63489169012513, 89.61398441513262}, 
        {95.59256273401685, 96.60492367518394, 3.2969009144911965}, 
        {7.841323399659572, 77.35534713240334, 48.05701854564004}, 
        {23.151702145679177, 52.1958842864779, 93.78015683059677}, 
        {44.09888355471582, 54.492917726594015, 24.622454476473166}, 
        {16.249910343196984, 0.3504857410388862, 85.0546555910392}, 
        {18.57436217213495, 11.641563654488696, 75.38762190150628}, 
        {48.887935758015544, 27.080530012653504, 24.035767788958985}, 
        {66.94012414945777, 73.23266032080303, 50.06399592340832}, 
        {92.92898432890647, 54.79065398456532, 26.58987366966179}, 
        {92.88555781398881, 18.758357735635144, 12.773937955254544}, 
        {25.9277654642454, 73.65600882998699, 77.16255402885054}, 
        {78.73073747066161, 3.228647969278131, 31.286824179414797}, 
        {78.9557861613077, 64.08632819676629, 32.76561823820734}, 
        {91.25062315733493, 24.883578484694123, 3.291487019225381}, 
        {39.99104034791093, 62.95314129332191, 49.38190890860557}, 
        {86.75055600046313, 18.194249230337554, 83.13729412230671}, 
        {77.32994631038211, 79.28053135983252, 59.07213186229132}, 
        {52.59359406359935, 70.22521942811584, 26.782995840661638}, 
        {60.34323901006218, 66.21644009647089, 12.528911708065094}, 
        {18.76756476382353, 63.15559220197979, 94.5920627623026}, 
        {11.271844583737156, 24.971638704603194, 29.556426061626805}, 
        {18.152320613291884, 81.84965369296255, 71.62876050229858}, 
        {2.469948915926401, 15.006408659268955, 75.6150057096136}, 
        {63.53636432502188, 76.43789464205852, 92.35789388253902}, 
        {67.8965703439952, 54.15708109269979, 35.74576865316249}, 
        {9.120070148052795, 89.15741635198806, 79.45978281410865}, 
        {63.50492780192457, 94.66712170605196, 79.93021458158391}, 
        {68.27606829760214, 45.1456083625194, 76.81363874686363}, 
        {45.65674871216846, 65.76092530514728, 76.61445161162649}, 
        {97.96428272513515, 8.5957248716227, 13.280657621682234}, 
        {43.96784888779063, 58.67975675402079, 7.0282521302813095}, 
        {96.73787610664478, 30.141260968535, 62.01339175937882}, 
        {80.35804986828707, 45.09077542752136, 19.058290942855148}, 
        {44.128576984340874, 89.63621460980104, 21.30113378607411}, 
        {5.692931908398369, 45.996173328023005, 15.130804872862846}, 
        {44.003229283569844, 42.44429999491426, 30.17968561049752}, 
        {84.97111904045155, 90.14890425602597, 29.880574471027632}, 
        {28.110350938803798, 14.04726821156781, 36.251128289066735}, 
        {73.39628348042687, 4.052303177275007, 64.1854487903767}, 
        {21.375943017446307, 98.71234373293179, 34.51805813821874}, 
        {34.880595654566534, 98.86990587513829, 32.95631610323353}, 
        {61.22935344205691, 24.946526296790594, 81.258600168947}, 
        {73.96395569818054, 8.487908704352199, 73.3884892030938}, 
        {39.87594377778281, 48.529508879072495, 3.541697999238036}, 
        {0.9871617812883593, 60.8395292595152, 1.6988556617291595}, 
        {20.407563319587084, 82.82883703639234, 94.68882291918852}, 
        {1.5453719300741908, 21.767788213587913, 71.32043906984123}, 
        {35.75234915554479, 41.00601801693801, 86.44917684127978}, 
        {28.45595208986579, 65.89949120046144, 38.21141450889044}, 
        {68.96828371706995, 18.076044376284596, 0.9918497452319319}, 
        {96.24075144470291, 61.56108085515728, 89.01376674941346}, 
        {31.423099134032494, 4.6563045398401615, 26.718766431522447}, 
        {2.1736387904774057, 30.184286882854327, 74.4806343525463}, 
        {32.248722209122505, 10.230165357126019, 44.24448926372014}, 
        {15.16339360017721, 34.54352910821562, 14.732050568147336}, 
        {88.05855385343123, 42.916955238913125, 32.4436144462965}, 
        {74.36397325987926, 35.39351428543872, 22.46946580616639}, 
        {52.78365221963397, 54.70158708281937, 41.66318089369805}, 
        {83.73353561923929, 52.968819847908186, 9.002196106687633}, 
        {62.67937630902569, 84.7235984339837, 28.913963033415733}, 
        {22.591774692627396, 13.492982264741526, 88.36585525757147}, 
        {2.785921002319569, 34.37019744380678, 6.736747096393314}, 
        {37.23859142962328, 85.99087672693955, 90.48751713662293}, 
        {36.98474755251778, 92.12573587569094, 98.72773962193742}, 
        {94.9331498897782, 45.49951242742451, 82.3277813649805}, 
        {2.772119875723633, 78.97791947239273, 89.33892865525708},
    };

    std::vector<double> q(100);
    std::vector<double> r(100 * 3);

    for (int i = 0; i < 100; i++) {
        q[i] = q_array[i];
        r[i * 3 + 0] = r_array[i][0];
        r[i * 3 + 1] = r_array[i][1];
        r[i * 3 + 2] = r_array[i][2];
    }

    double s = 5.0;
    std::vector<double> potentials(4);
    std::vector<double> alphas = {0.2, 0.3, 0.4, 0.5};

    for (int i = 0; i < 4; i++) {
        double alpha = alphas[i];
        hpdmk::Ewald ewald(100.0, s, alpha, 1.0, q, r, 100);

        EXPECT_DOUBLE_EQ(ewald.L, 100.0);
        EXPECT_DOUBLE_EQ(ewald.s, s);
        EXPECT_DOUBLE_EQ(ewald.alpha, alpha);
        EXPECT_DOUBLE_EQ(ewald.eps, 1.0);

        omp_set_num_threads(4);

        double E = ewald.compute_energy();

        // -0.07897291545871976 is a reference result calculated by EwaldSummations.jl
        EXPECT_NEAR(E / (4 * M_PI), -0.07897291545871976, 1e-10);

        double trg_x = 10.0;
        double trg_y = 10.0;
        double trg_z = 10.0;

        double V = ewald.compute_potential(trg_x, trg_y, trg_z);
        potentials[i] = V;
    }

    EXPECT_NEAR(potentials[0], potentials[1], 1e-10);
    EXPECT_NEAR(potentials[0], potentials[2], 1e-10);
    EXPECT_NEAR(potentials[0], potentials[3], 1e-10);
}